---
title: "asreml results for Jane Manfredi"
author: "Aaron Rendahl, PhD"
date: "March 14, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE)
library(knitr)
library(dplyr)
library(ggplot2)
```

Results from Rob's computer, using R version 3.3.1 (2016-06-21) and asreml 3.0.

### Wald tests
```{r}
w <- read.csv("results-wald.csv", as.is=TRUE)
w %>% kable(digits=c(0,0,2,0,4))
```

### plots
```{r}
d <- read.csv("results-fit.csv", as.is=TRUE)
d$p <- d$predicted.value
d$lo <- d$predicted.value - d$standard.error
d$hi <- d$predicted.value + d$standard.error
d$p <- ifelse(d$response=="insulin", exp(d$p), d$p)
d$lo <- ifelse(d$response=="insulin", exp(d$lo), d$lo)
d$hi <- ifelse(d$response=="insulin", exp(d$hi), d$hi)

ds <- split(d, d[,c("response", "var")])

## put plots in the starting order
foo <- unique(d[,c("response", "var")])
foo$v <- paste(foo$response, foo$var, sep=".")
stopifnot(foo$v %in% names(ds))
foo$var <- factor(foo$var, levels=unique(foo$var))
foo <- foo[order(foo$var, foo$response),]
ds <- ds[foo$v]

## fix the level names for continuous variables
for(i in seq_along(ds)) {
  foo <- as.numeric(as.character(ds[[i]]$level))
  if(!any(is.na(foo))) {
    #ds[[i]]$level <- paste(round(foo,2))
    ds[[i]]$level <- factor(foo, labels=c("mean", "mean + SE"))
  } else {
    ds[[i]]$level <- factor(ds[[i]]$level)
  }
}

## make the plots
ps <- lapply(seq_along(ds), function(i) {
  p <- ggplot(ds[[i]]) + 
    aes(time, p, ymin=lo, ymax=hi, group=level, linetype=level) + 
    geom_ribbon(alpha=0.3, linetype=0) +
    geom_line() +
    ggtitle(names(ds)[i]) + ylab(ds[[i]]$response[1]) +
    scale_x_continuous(breaks=(0:6)*30, expand=c(0,0)) +
    theme_classic() +
    theme(legend.title=element_blank())
  if(nlevels(ds[[i]]$level)==1) {
    p <- p + guides(linetype=FALSE)
  }
  p
})
names(ps) <- names(ds)

tmp <- subset(ds$insulin.Breed, time==60, select=c(level, p, time))
ps$insulin.Breed <- ps$insulin.Breed + 
  geom_text(aes(x=time, y=p, label=level), data=tmp, inherit.aes=FALSE)

tmp <- subset(ds$glucose.Breed, time==120, select=c(level, p, time))
ps$glucose.Breed <- ps$glucose.Breed + 
  geom_text(aes(x=time, y=p, label=level), data=tmp, inherit.aes=FALSE)


for(p in ps) plot(p)


## make the plots
# for(i in seq_along(ds)) {
#   p <- ggplot(ds[[i]]) + aes(time, p, group=level, color=level) + 
#     geom_line() +
#     geom_line(aes(y=lo), lty=2) +
#     geom_line(aes(y=hi), lty=2) +
#     ggtitle(names(ds)[i]) + ylab(ds[[i]]$response[1]) +
#     scale_x_continuous(breaks=(0:6)*30) +
#     theme(legend.title=element_blank())
#   if(nlevels(ds[[i]]$level)<=2) {
#     p <- p + scale_color_manual(values=c("black", "blue"))
#   }
#   if(nlevels(ds[[i]]$level)==1) {
#     p <- p + guides(color=FALSE)
#   }
#   plot(p)
# }
```